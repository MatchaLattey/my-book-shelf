<!DOCTYPE html>
<html>
<head>
  <style>
    :root { --frame-color: #b68d6d; --shelf-bg: #fffaf2; }
    body { background-color: transparent; display: flex; justify-content: center; padding: 10px; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    
    /* SETTINGS MENU */
    #settings-container { position: fixed; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
    #gear-icon { font-size: 24px; cursor: pointer; background: white; border-radius: 50%; padding: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    #settings-menu { display: none; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 250px; margin-top: 8px; font-size: 12px; max-height: 85vh; overflow-y: auto; }
    #settings-container:hover #settings-menu { display: block; }
    .menu-header { font-weight: bold; font-size: 14px; margin-bottom: 10px; border-bottom: 2px solid #6b4f3a; color: #6b4f3a; display: flex; justify-content: space-between; align-items: center; }
    .sync-btn { padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; }
    .setting-item { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
    .setting-item label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    input[type="text"], select { width: 92%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 8px; }
    input[type="range"] { width: 100%; cursor: pointer; }
    .save-btn { width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

    /* BOOKCASE */
    .bookcase { width: 450px; background: var(--frame-color); display: grid; grid-template-rows: repeat(4, 1fr); gap: 15px; padding: 20px; border: 10px solid #a37a5a; border-radius: 4px; }
    .shelf { height: 120px; background-color: var(--shelf-bg); border-bottom: 8px solid #a37a5a; display: flex; align-items: flex-end; padding: 0 10px; gap: 4px; position: relative; overflow-x: auto; overflow-y: hidden; white-space: nowrap; cursor: grab; }
    .shelf:active { cursor: grabbing; }

    /* BOOKS */
    .book { flex: 0 0 auto; position: relative; z-index: 10; border: 1px solid rgba(0,0,0,0.1); border-radius: 2px 2px 0 0; transition: transform 0.2s; display: flex; justify-content: center; align-items: center; writing-mode: vertical-rl; font-size: 10px; font-weight: 800; color: #000; text-transform: uppercase; box-shadow: inset -2px 0 5px rgba(0,0,0,0.05); user-select: none; }
    .book:hover { transform: translateY(-10px) scale(1.1); z-index: 500 !important; }
    .book-thin { width: 22px; height: 80px; }
    .book-standard { width: 34px; height: 95px; }
    .book-fat { width: 48px; height: 110px; }
    .tilt-left { transform: rotate(-6deg); transform-origin: bottom; margin-right: 4px; }
    .tilt-right { transform: rotate(6deg); transform-origin: bottom; margin-left: 4px; }

    /* STATUS BADGE */
    .status-badge {
      position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
      width: 18px; height: 18px; border-radius: 50%; background: white;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; writing-mode: horizontal-tb; border: 1.5px solid #6b4f3a;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 20;
    }

    /* DECORATIONS */
    .deco { position: absolute; bottom: 5px; z-index: 200; pointer-events: none; }
  </style>
</head>
<body>

<div id="settings-container">
  <div id="gear-icon">‚öôÔ∏è</div>
  <div id="settings-menu">
    <div class="menu-header">Shelf Settings <button class="sync-btn" onclick="fetchBooks()">üîÑ SYNC</button></div>
    <div class="setting-item">
      <label>Wood Color</label>
      <input type="color" id="colorPicker" onchange="updateColor(this.value)">
    </div>
    <div class="setting-item">
      <label>‚è∞ Right Item</label>
      <input type="text" id="clockUrlInput" placeholder="Image URL" onchange="updateDecoUrl('clock', this.value)">
      <select id="clockShelfSelect" onchange="moveDeco('clock', this.value)">
        <option value="1">Shelf 1</option><option value="2">Shelf 2</option><option value="3">Shelf 3</option><option value="4">Shelf 4</option>
      </select>
      <input type="range" id="clockSizeRange" min="20" max="200" value="45" oninput="resizeDeco('clock', this.value)">
    </div>
    <div class="setting-item">
      <label>ü™¥ Left Item</label>
      <input type="text" id="plantUrlInput" placeholder="Image URL" onchange="updateDecoUrl('plant', this.value)">
      <select id="plantShelfSelect" onchange="moveDeco('plant', this.value)">
        <option value="1">Shelf 1</option><option value="2">Shelf 2</option><option value="3">Shelf 3</option><option value="4">Shelf 4</option>
      </select>
      <input type="range" id="plantSizeRange" min="20" max="200" value="60" oninput="resizeDeco('plant', this.value)">
    </div>
    <button class="save-btn" onclick="saveSettings()">üíæ SAVE DESIGN</button>
  </div>
</div>

<div class="bookcase">
  <div class="shelf" id="shelf-1"></div>
  <div class="shelf" id="shelf-2"></div>
  <div class="shelf" id="shelf-3"></div>
  <div class="shelf" id="shelf-4"></div>
</div>

<script>
  let config = {
    workerUrl: 'https://notion-bridge.violily67.workers.dev/', 
    color: '#b68d6d',
    clockImg: 'https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3B4eW13bmZ5ZnR4eW13bmZ5ZnR4eW13bmZ5ZnR4eW13bmZ5JmVwPXYxX2ludGVybmFsX2dpZl9ieV9pZCZjdD1z/3o7TKVUn7iM8FMEU24/giphy.gif',
    plantImg: 'https://i.pinimg.com/originals/1f/4e/ba/1f4eba6f27790b213ba570f8ba63273c.gif',
    clockShelf: '2', plantShelf: '3', clockSize: '45', plantSize: '60'
  };

  const ghibliPalette = ['#e8d1b5', '#d9adad', '#b5c9c3', '#c7d6a5', '#dfc5e0', '#f4e3ad', '#a7c1d1', '#d2b48c'];

  function loadSettings() {
    const saved = localStorage.getItem('ghibli_shelf_cfg');
    if (saved) { config = JSON.parse(saved); updateColor(config.color); }
  }

  function updateColor(val) { config.color = val; document.documentElement.style.setProperty('--frame-color', val); }
  function resizeDeco(type, val) { config[type + 'Size'] = val; const img = document.getElementById(type + '-id'); if (img) img.style.width = val + 'px'; }
  function updateDecoUrl(type, url) { if (type === 'clock') config.clockImg = url; else config.plantImg = url; moveDeco(type, config[type + 'Shelf']); }

  function moveDeco(type, shelfId) {
    config[type + 'Shelf'] = shelfId;
    const old = document.getElementById(type + '-id'); if (old) old.remove();
    const shelf = document.getElementById(`shelf-${shelfId}`);
    if(!shelf) return;
    const img = document.createElement('img');
    img.id = type + '-id';
    img.src = type === 'clock' ? config.clockImg : config.plantImg;
    img.className = 'deco';
    img.style.width = config[type + 'Size'] + 'px';
    if (type === 'clock') img.style.right = '10px'; else img.style.left = '10px';
    shelf.appendChild(img);
  }

  function saveSettings() { localStorage.setItem('ghibli_shelf_cfg', JSON.stringify(config)); alert("Settings Saved!"); }

  function getStatusEmoji(status) {
    if (!status) return "";
    const s = status.toLowerCase().trim();

    // 1. Done (The Sparkle)
    if (s.includes("done")) return "‚ú®"; 
    
    // 2. Reading (The Seedling - currently in your hands)
    // We check for "reading" first so it doesn't get caught by "going"
    if (s.includes("reading")) return "üå±"; 
    
    // 3. On-going (The Open Book - for series or manga)
    if (s.includes("going")) return "üìñ"; 

    // 4. To Read (The Hourglass - waiting on the shelf)
    if (s.includes("read")) return "‚è≥"; 

    return "";
  }

  async function fetchBooks() {
    loadSettings();
    try {
      const response = await fetch(`${config.workerUrl}?t=${Date.now()}`);
      const books = await response.json();
      document.querySelectorAll('.book').forEach(b => b.remove());
      moveDeco('clock', config.clockShelf);
      moveDeco('plant', config.plantShelf);

      books.forEach(book => {
        const shelf = document.getElementById(`shelf-${book.shelf}`);
        if (shelf) {
          const el = document.createElement('div');
          const sizeClass = ['book-thin', 'book-standard', 'book-fat'][Math.floor(Math.random() * 3)];
          const tiltClass = ['', 'tilt-left', 'tilt-right'][Math.floor(Math.random() * 3)];
          
          el.className = `book ${sizeClass} ${tiltClass}`;
          el.style.backgroundColor = ghibliPalette[Math.floor(Math.random() * ghibliPalette.length)];
          el.innerText = book.title.substring(0, 10);
          
          const emoji = getStatusEmoji(book.status);
          if (emoji) {
            const badge = document.createElement('div');
            badge.className = 'status-badge';
            badge.innerText = emoji;
            el.appendChild(badge);
          }
          
          shelf.appendChild(el);
        }
      });
    } catch (e) { console.error(e); }
  }

  document.querySelectorAll('.shelf').forEach(shelf => {
    let isDown = false, startX, scrollLeft;
    shelf.addEventListener('mousedown', (e) => { isDown = true; startX = e.pageX - shelf.offsetLeft; scrollLeft = shelf.scrollLeft; });
    shelf.addEventListener('mouseleave', () => isDown = false);
    shelf.addEventListener('mouseup', () => isDown = false);
    shelf.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - shelf.offsetLeft; const walk = (x - startX) * 2; shelf.scrollLeft = scrollLeft - walk; });
  });

  fetchBooks();
</script>
</body>
</html>
