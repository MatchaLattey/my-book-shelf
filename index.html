<!DOCTYPE html>
<html>
<head>
  <style>
    :root { --frame-color: #b68d6d; --shelf-bg: #fffaf2; }
    body { background-color: transparent; display: flex; justify-content: center; padding: 10px; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
    
    /* SETTINGS MENU */
    #settings-container { position: fixed; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
    #gear-icon { font-size: 24px; cursor: pointer; background: white; border-radius: 50%; padding: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    #settings-menu { display: none; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 250px; margin-top: 8px; font-size: 12px; max-height: 85vh; overflow-y: auto; }
    #settings-container:hover #settings-menu { display: block; }
    .menu-header { font-weight: bold; font-size: 14px; margin-bottom: 10px; border-bottom: 2px solid #6b4f3a; color: #6b4f3a; display: flex; justify-content: space-between; align-items: center; }
    .sync-btn { padding: 4px 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; }
    .save-btn { width: 100%; padding: 12px; background: #2ecc71; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

    /* BOOKCASE & SHELF */
    .bookcase { 
      width: 450px; background: var(--frame-color); 
      display: grid; grid-template-rows: repeat(4, 1fr); gap: 15px; 
      padding: 20px; border: 10px solid #a37a5a; border-radius: 4px;
      overflow: hidden; 
    }
    .shelf { 
      height: 140px; background-color: var(--shelf-bg); border-bottom: 8px solid #a37a5a; 
      display: flex; align-items: flex-end; padding: 0 15px; gap: 2px; position: relative; 
      overflow-x: auto; overflow-y: hidden; white-space: nowrap; cursor: grab;
    }

    /* BOOKS - SMART TILT READY */
    .book { 
      flex: 0 0 auto; position: relative; z-index: 10; 
      border: 1px solid rgba(0,0,0,0.1); border-radius: 2px 2px 0 0;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      display: flex; justify-content: center; align-items: center;
      writing-mode: vertical-rl; text-orientation: mixed;
      font-size: 9px; font-weight: 800; color: #333;
      text-transform: uppercase; padding: 15px 4px;
      box-shadow: inset -2px 0 5px rgba(0,0,0,0.05); 
      white-space: normal; text-align: center;
      line-height: 1.2; word-break: break-word;
      transform-origin: bottom; /* Crucial for smart tilt */
    }
    
    .book:hover { transform: translateY(-5px) scale(1.05) rotate(0deg) !important; z-index: 500 !important; }

    /* SMART TILT CLASSES */
    .tilt-left-strong { transform: rotate(-7deg); margin-right: 5px; }
    .tilt-left-soft { transform: rotate(-3deg); margin-right: 2px; }
    .tilt-right-strong { transform: rotate(7deg); margin-left: 5px; }
    .tilt-right-soft { transform: rotate(3deg); margin-left: 2px; }
    .tilt-none { transform: rotate(0deg); }

    .status-badge {
      position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%);
      width: 15px; height: 15px; border-radius: 50%; background: rgba(255,255,255,0.9);
      display: flex; align-items: center; justify-content: center;
      font-size: 9px; writing-mode: horizontal-tb; border: 1px solid #6b4f3a;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 20;
    }

    .book-thin { width: 22px; height: 100px; }
    .book-standard { width: 34px; height: 115px; }
    .book-fat { width: 46px; height: 125px; }
    .deco { position: absolute; bottom: 5px; z-index: 200; pointer-events: none; }
  </style>
</head>
<body>

<div id="settings-container">
  <div id="gear-icon">‚öôÔ∏è</div>
  <div id="settings-menu">
    <div class="menu-header">Shelf Settings <button class="sync-btn" onclick="fetchBooks()">üîÑ SYNC</button></div>
    <button class="save-btn" onclick="saveSettings()">üíæ SAVE DESIGN</button>
  </div>
</div>

<div class="bookcase">
  <div id="shelf-1" class="shelf"></div><div id="shelf-2" class="shelf"></div>
  <div id="shelf-3" class="shelf"></div><div id="shelf-4" class="shelf"></div>
</div>

<script>
  let config = { workerUrl: 'https://notion-bridge.violily67.workers.dev/', color: '#b68d6d' };
  const ghibliPalette = ['#e8d1b5', '#d9adad', '#b5c9c3', '#c7d6a5', '#dfc5e0', '#f4e3ad', '#a7c1d1', '#d2b48c'];

  function getStatusEmoji(status) {
    if (!status) return "";
    const s = status.toString().toLowerCase().trim();
    if (s.includes("done")) return "‚ú®";
    if (s.includes("reading")) return "üå±";
    if (s.includes("going")) return "üìñ";
    if (s.includes("read")) return "‚è≥";
    return "";
  }

  // THE SMART TILT LOGIC
  function getSmartTilt(index, total) {
    if (index === 0) return 'tilt-left-strong'; // Leaning against left wall
    if (index === total - 1) return 'tilt-right-strong'; // Leaning against right wall
    
    // Middle logic
    const pattern = index % 5;
    if (pattern === 1) return 'tilt-left-soft';
    if (pattern === 3) return 'tilt-right-soft';
    return 'tilt-none';
  }

  async function fetchBooks() {
    try {
      const response = await fetch(`${config.workerUrl}?t=${Date.now()}`);
      const allBooks = await response.json();
      document.querySelectorAll('.book').forEach(b => b.remove());

      // Group books by shelf to apply smart tilt correctly per shelf
      for (let s = 1; s <= 4; s++) {
        const shelfEl = document.getElementById(`shelf-${s}`);
        const shelfBooks = allBooks.filter(b => b.shelf == s);
        
        shelfBooks.forEach((book, index) => {
          const el = document.createElement('div');
          const sizes = ['book-thin', 'book-standard', 'book-fat'];
          
          // Apply smart tilt based on position
          const tiltClass = getSmartTilt(index, shelfBooks.length);
          
          el.className = `book ${sizes[Math.floor(Math.random()*3)]} ${tiltClass}`;
          el.style.backgroundColor = ghibliPalette[Math.floor(Math.random() * ghibliPalette.length)];
          el.innerText = book.title || "UNTITLED";
          
          const emoji = getStatusEmoji(book.status);
          if (emoji) {
            const badge = document.createElement('div');
            badge.className = 'status-badge';
            badge.innerText = emoji;
            el.appendChild(badge);
          }
          shelfEl.appendChild(el);
        });
      }
    } catch (e) { console.error(e); }
  }

  fetchBooks();
</script>
</body>
</html>
